# HEADER
Bootstrap: docker
From: ubuntu:20.04

# SECTIONS
%files
    README.md
    setup.py
    gpu_environment.yml

%post

    # *** Switch to Non-interactive Mode
    export DEBIAN_FRONTEND=noninteractive

    # *** OS Upgrade & Install
    apt update && apt upgrade -y
    apt install -y git wget \
        build-essential \
        ca-certificates \
        libgl1-mesa-glx \
        libegl1-mesa \
        libxrandr2 \
        libxss1 \
        libxcursor1 \
        libxcomposite1 \
        libasound2 \
        libxi6 \
        libxtst6

    # *** Reconfigure Shell
    dpkg-reconfigure dash

    # Installing Anaconda3 (Silent Mode)
    # wget -c https://repo.anaconda.com/archive/Anaconda3-2021.11-Linux-x86_64.sh -O anaconda.sh
    wget -c https://repo.anaconda.com/miniconda/Miniconda3-py38_4.11.0-Linux-x86_64.sh -O anaconda.sh
    bash anaconda.sh -bp /opt/anaconda/

    # Load Anaconda Environment Variables
    . /opt/anaconda/etc/profile.d/conda.sh

    # Update Conda
    conda update conda

    # *** Setting Up Envrionmnet
    conda env create -f gpu_environment.yml python=3.8
    conda activate exatrkx
    pip install -e .

    # *** Setup Conda Init ***
    mv ~/.bashrc ~/.bashrcold
    conda init
    cat ~/.bashrc >> /etc/conda.init
    echo conda activate exatrkx >> /etc/conda.init
    conda clean -afy
    mv ~/.bashrcold ~/.bashrc

    # *** Cleanup
    apt clean && \
    rm -rf /var/lib/apt/lists/*
    rm *.sh *.yml *.md

%environment
    # This setting is for "singularity shell" command
    action="${1##*/}"
    if [ "$action" = "shell" ]; then
        if [ "${SINGULARITY_SHELL:-}" = "/bin/bash" ]; then
            set -- --noprofile --init-file /etc/conda.init
        elif test -z "${SINGULARITY_SHELL:-}"; then
            export SINGULARITY_SHELL=/bin/bash
            set -- --noprofile --init-file /etc/conda.init
        fi
    fi

%runscript
    BASH_ENV=/etc/conda.init exec /bin/bash --noprofile --init-file /etc/conda.init "$@"

%labels
    Author: Adeel Akram <adeel.chep@gmail.com>
    Dated : 01-01-2022

%help
    Singularity container for building PyTorch using Spack package manager.

    Build the container from definition file.
    $ sudo singularity build gpu_exatrkx.sif gpu_exatrkx.def

    One can build a sandbox container as the following
    $ sudo singularity build --sandbox gpu_exatrkx gpu_exatrkx.def

    Run the Container
    $ singularity run gpu_exatrkx.sif -c "conda activate exatrkx && python main.py"
